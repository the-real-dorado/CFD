# A computational fluid dynamics package for Python

## Solver

The motion of an incompressible Newtonian fluid (with constant density and viscosity) is described by the Navier-Stokes equations

$$\nabla \cdot \vec{u} = 0$$  
$$\dfrac{\partial \vec{u}}{\partial t} + (\vec{u} \cdot \nabla)\vec{u} = \nu \nabla ^2  \vec{u} -\nabla p' + \vec{g}$$  

Taking the divergence of the momentum equation and simplifying using the continuity equation yields a Poisson equation for the pressure field

$$\nabla ^2 p' = - \nabla \cdot ( ( \vec{u} \cdot \nabla ) \vec{u} )$$  

The pressure is computed using the intermediate velocity by Jacobi iteration, then the velocity is updated using this pressure.

## Functions

The package runs a `simulation` by applying the boundary conditions on the `fluid` object which is made using the `domain` function and solving the equations till convergence (steady state flow), then the `data` module is used to `export` or `plot` the velocity and pressure fields.

For domain mesh, .obj files are parsed. I use [Blender](https://www.blender.org/) for creating them. The package only solves in 2D; mesh must be in the XY-plane (Blender .obj export settings: "Forward: Y Forward", "Up: Z Up").  

## Dependencies

- [NumPy](https://numpy.org/)
- [Numba](http://numba.pydata.org/)
- [Matplotlib](https://matplotlib.org/)

## Usage

An [example](https://github.com/the-real-dorado/CFD/blob/main/CFD_example.ipynb) Jupyter notebook showing package usage is in the repository.  

As with any package that is not on `pip`, copy the package folder to the directory of the file to be used in, then import in file.

```python:
import CFD
```

To define domain and boundary conditions for fluid use the `domain` function which returns the necessary data for the `fluid` object.

```python:
domain = CFD.domain(file,dl,Nx,Ny,display=False)
```

Set `file` to path of .obj mesh of the complex domain (or `None`, for a simple rectangular domain) which has been discretized into `Nx` by `Ny` squares of side `dl`(=`dx`=`dy` in equations). The code parses empty space in the imported mesh file as walls with no-slip condition (sample [meshes](https://github.com/the-real-dorado/CFD/tree/main/meshes) are provided in repository). To check if mesh has been imported correctly, set `display` to `True` to render and view domain before simulation (does not change `data.plot` output, that always shows domain) where dark regions are walls.

The simulation results will be stored in a `fluid` object.

```python:
fluid = CFD.fluid(domain,nu=1e-6)
```

Boundary conditions are specific by a function with arguments `Ux`, `Uy`, `p`, `Nx`, and `Ny` which returns the set values of `Ux`, `Uy`, `p`, `gx` and `gy`; where arrays `Ux`, `Uy` are XY-components of velocity field $\vec{u}$, array `p` is pressure field $p$, and `gx`, `gy` are XY-components of the body acceleration $\vec{g}$ acting on entire domain.  

`models` module contains functions which will return the boundary condition function `bc` and body acceleration `gx` and `gy`:

- `flow(domain,gx,gy)`
  - flow generated by constant $\vec{g}$ acting on entire domain
  - used to simulate pressure gradient-driven flow
  - domain unbounded in X and Y
  - uses complex domain
- `channel(gx)`
  - channel flow in X-direction with no-slip walls at `y=0` and `y=dl*Ny`
  - domain unbounded in X
  - uses simple rectangular domain
- `lid(Ux)`
  - standard lid-driven cavity problem model
  - bounded domain
  - uses simple rectangular domain

```python:
model = CFD.models.flow(domain,gx,gy)
```

`simulation` then solves the equations for pressure and velocity.

```python:
CFD.simulation(fluid,model,*,dt=1e-6,p_it=200,rt=5e-4,max_it=10000)
```

 `dt` is the time step, `rt` is the target relative tolerance of the convergence criterion which is based on the Frobenius norm of the difference between velocity fields, and `max_it` is the maximum number of iterations to solve for. `p_it` is the number of Jacobi iterations used when computing pressure.

The `fluid` object will be updated after successful run.

`data` module is then used to handle the simulation results:

- `plot(fluid,plots=['velocity','streamlines'],path='',info=False)`
  - `plots` takes the data for a single plot (use `data.plot` again for different plot). Pass `velocity` or `pressure` for respective contours and (optionally) `streamlines` for overlaying streamlines (sample output [plots](https://github.com/the-real-dorado/CFD/tree/main/plots) are provided in repository).
  - Use `path` to change output file location in the file directory.
  - set `info` to `True` to plot scale and show title.
- `export(fluid,path='')`
  - Exports data to a `.csv` file.

```python:
CFD.data.plot(fluid,plots=['velocity','streamlines'],path='',info=False)
```
